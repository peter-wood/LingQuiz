#!/usr/bin/env node
var express = require('express');
var config = require(__dirname + '/lib/config.js');
var mongo = require(__dirname + '/lib/db.js');
var auth = require(__dirname + '/lib/auth.js');
var cookieParser = require('cookie-parser')
mongo.connect();
mongo.init();
mongo.printAll();

var app = express();

var logAll = function(req, res, next) {
	app.locals.myPath = req.path; // save current path so we can recall it in routes
	var key = null;
	if (req.cookies && req.cookies.myLingKey) {
		key = req.cookies['myLingKey'];
	}
	console.log('key: ' + key);

	re = /^\/resources/
	if (re.test(req.path)) {
		console.log('Attempt to access resources. key: %s', key);
		if (!auth.hasPermission(key)) {
			console.log('not authorized');
			res.end('Not authorized to access resources');
	        } else {
			console.log('authorized :-)');
			next();
		}
	} else {
		next();
	}
}		

app.use(cookieParser());
app.use(logAll);

setInterval(auth.purgeAuth, config.purgeInterval * 1000);


var fs = require('fs');

var authenticate = require(__dirname + '/routes/authenticate');
var docs = require(__dirname + '/routes/docs');
// var book = require(__dirname + '/routes/book');
// var handouts = require(__dirname + '/routes/handouts');
// var slides = require(__dirname + '/routes/slides');

app.use('/auth', authenticate);
app.use('/book_res', docs);
app.use('/handouts_res', docs);
app.use('/slides_res', docs);
app.use('/resources/book', express.static(__dirname + '/resources/book/'));
app.use('/resources/handouts', express.static(__dirname + '/resources/handouts/'));
app.use('/resources/slides', express.static(__dirname + '/resources/slides/'));

var server = app.listen(config.port, function () {
	console.log('Listening on port %d', server.address().port);
	console.log('Setup: %s', config.setup);
	console.log('Deployment: %s', config.deployment);
	// mongo.getQuestion(function(data) {
	//	console.log(data);
	// });
});

