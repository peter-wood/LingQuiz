#!/usr/bin/env node
var express = require('express');
var config = require('./lib/config.js');
var mongo = require('./lib/db.js');
var auth = require('./lib/auth.js');
var cookieParser = require('cookie-parser');
mongo.connect();
mongo.init();
mongo.printAll();

var app = express();

var logAll = function(req, res, next) {
	// app.set('currentPath', req.path);
	next()
};

app.use(logAll);
app.use(cookieParser());
setInterval(auth.purgeAuth, 30000);


var fs = require('fs');

var authenticate = require('./routes/authenticate');
// var dirTransfer = require('./routes/dirTransfer');
var book = require('./routes/book');
var handouts = require('./routes/handouts');
var slides = require('./routes/slides');

var download = require('./routes/download');


app.use('/book', book);
app.use('/handouts', dirTransfer);
app.use('/slides', dirTransfer);
app.use('/auth', authenticate);
app.use('/download', download);
app.use('/js', express.static('./webroot/js'));
app.use('/css', express.static('./webroot/css'));
app.use('/partials', express.static('./webroot/partials'));
app.use('/bower_components', express.static('./webroot/bower_components'));
app.all('*', function(req, res, next) {
    res.sendfile('./webroot/index.html');
    });

// app.listen(8000);

var server = app.listen(config.port, function () {
	console.log('Listening on port %d', server.address().port);
	console.log('Setup: %s', config.setup);
	console.log('Deployment: %s', config.deployment);
});

