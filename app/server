#!/usr/bin/env node
var express = require('express');
var config = require(__dirname + '/lib/config.js');
var mongo = require(__dirname + '/lib/db.js');
var auth = require(__dirname + '/lib/auth.js');
var cookieParser = require('cookie-parser');
mongo.connect();
mongo.init();
mongo.printAll();

var app = express();

var logAll = function(req, res, next) {
	// app.set('currentPath', req.path);
	next()
};

app.use(logAll);
app.use(cookieParser());
setInterval(auth.purgeAuth, 30000);


var fs = require('fs');

var authenticate = require(__dirname + '/routes/authenticate');
var book = require(__dirname + '/routes/book');
var handouts = require(__dirname + '/routes/handouts');
var slides = require(__dirname + '/routes/slides');
//var dirTransfer = require(__dirname + '/routes/dirTransfer');

var download = require(__dirname + '/routes/download');


app.use('/book_res', book);
app.use('/handouts_res', handouts);
app.use('/slides_res', slides);
app.use('/auth', authenticate);
app.use('/download', download);
app.use('/js', express.static(__dirname + '/webroot/js'));
app.use('/css', express.static(__dirname + '/webroot/css'));
app.use('/partials', express.static(__dirname + '/webroot/partials'));
app.use('/bower_components', express.static(__dirname + '/webroot/bower_components'));
app.all('*', function(req, res, next) {
    res.sendfile(__dirname + '/webroot/index.html');
    });

// app.listen(8000);

var server = app.listen(config.port, function () {
	console.log('Listening on port %d', server.address().port);
	console.log('Setup: %s', config.setup);
	console.log('Deployment: %s', config.deployment);
});

